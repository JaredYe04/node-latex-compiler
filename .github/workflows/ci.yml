name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    strategy:
      matrix:
        include:
          - platform: linux
            arch: x64
            runner: ubuntu-latest
            node-version: '20.x'
          - platform: win32
            arch: x64
            runner: windows-latest
            node-version: '20.x'
          - platform: darwin
            arch: x64
            runner: macos-14
            node-version: '20.x'
          - platform: darwin
            arch: arm64
            runner: macos-14
            node-version: '20.x'
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Download Tectonic binary
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_PLATFORM: ${{ matrix.platform }}
          FORCE_ARCH: ${{ matrix.arch }}
        run: |
          echo "üì• Downloading Tectonic binary for ${{ matrix.platform }} ${{ matrix.arch }}..."
          node scripts/download-tectonic.js || {
            echo "‚ùå Binary download failed"
            exit 1
          }

      - name: Verify binary exists
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "win32" ]; then
            BINARY="bin/${{ matrix.platform }}-${{ matrix.arch }}/tectonic.exe"
          else
            BINARY="bin/${{ matrix.platform }}-${{ matrix.arch }}/tectonic"
          fi
          
          if [ ! -f "$BINARY" ]; then
            echo "‚ùå Error: Binary not found at $BINARY"
            exit 1
          fi
          
          echo "‚úÖ Binary found at $BINARY"
          
          # Verify binary works
          if [ "${{ matrix.platform }}" = "win32" ]; then
            "$BINARY" --help > /dev/null 2>&1 || {
              echo "‚ùå Binary verification failed"
              exit 1
            }
          else
            chmod +x "$BINARY"
            "$BINARY" --help > /dev/null 2>&1 || {
              echo "‚ùå Binary verification failed"
              exit 1
            }
          fi
          
          echo "‚úÖ Binary verification passed"

      - name: Run compilation tests
        shell: bash
        run: |
          echo "üß™ Running compilation tests on ${{ matrix.platform }} ${{ matrix.arch }}..."
          node scripts/test-compilation.js || {
            echo "‚ùå Tests failed"
            exit 1
          }
          echo "‚úÖ All tests passed"

      - name: Verify test output
        shell: bash
        run: |
          TEST_OUTPUT_DIR="test-output"
          if [ ! -d "$TEST_OUTPUT_DIR" ]; then
            echo "‚ùå Test output directory not found"
            exit 1
          fi
          
          PDF_FILES=$(find "$TEST_OUTPUT_DIR" -name "*.pdf" 2>/dev/null || echo "")
          if [ -z "$PDF_FILES" ]; then
            echo "‚ùå No PDF files found in test output"
            exit 1
          fi
          
          echo "‚úÖ Found PDF files in test output:"
          echo "$PDF_FILES"
          
          # Verify PDF files are not empty
          for pdf in $PDF_FILES; do
            if [ ! -s "$pdf" ]; then
              echo "‚ùå PDF file is empty: $pdf"
              exit 1
            fi
          done
          
          echo "‚úÖ All PDF files are valid"

      - name: Check for temporary files in root
        shell: bash
        run: |
          # Check if any temporary files were left in root directory
          TEMP_FILES=$(find . -maxdepth 1 -name "__temp_compile_*" 2>/dev/null || echo "")
          if [ -n "$TEMP_FILES" ]; then
            echo "‚ö†Ô∏è  Warning: Temporary files found in root directory:"
            echo "$TEMP_FILES"
            echo "These should be in the temp/ directory"
            # Don't fail the build, but warn
          else
            echo "‚úÖ No temporary files in root directory"
          fi

